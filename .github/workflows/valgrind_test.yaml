name: valgrind-gtest

on:
  pull_request:
    types: ["opened", "synchronize", "reopened"]

permissions:
  pull-requests: write
  issues: write

jobs:
  valgrind:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
            ref: ${{ github.event.pull_request.head.sha }}
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++ valgrind nlohmann-json3-dev 

      - name: Configure
        run: cmake -S . -B build

      - name: Build g_test
        run: cmake --build build

      - name: Run g_test under Valgrind
        id: valgrind
        shell: bash
        run: |
          valgrind \
            --leak-check=full \
            --show-leak-kinds=all \
            --track-origins=yes \
            --error-exitcode=0 \
            ./build/g_test 2> >(tee build/valgrind.log >&2)
          # Extract summary text
          {
            echo "### ðŸ§  Valgrind Leak Summary"
            echo '```'
            awk '/LEAK SUMMARY:/,0' build/valgrind.log || true
            grep -E 'ERROR SUMMARY:' build/valgrind.log || true
            echo '```'
          } > build/valgrind-summary.txt

      - name: Comment Valgrind summary on PR
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-file: build/valgrind-summary.txt
